---
title: "Variable selection for shrimp data with conditional random forest"
output: html_notebook
---

This notebook describes the variable selection process for predicting the price of shrimp from various predictors using conditional random forest (cRF). This approach of regression tree and bagging procedure is different from the original random forest in the way it selects variables.  Variable selection statistics for each variable is calculated conditional on other variables. This apparently is more robust to correlated variables.  

The conditional random forest approach is used to select variables that are most useful in predicting the price of shrimp. Then the relationships between each of the selected variables and price are examined. 

In the next section, I converted categorical variables into integer variables.  This was unnecessary but easier to deal with than having named categories.  
```{r}
rm(list=ls())
library(tidyverse)
library(party)
library(rfPermute)
library(randomForestExplainer)

ntree <- 5000
shrimp.data.raw <- readRDS(file = "RData/shrimp_data.rds")
shrimp.data <- shrimp.data.fcn(shrimp.data.raw)
# add wild vs. aquaculture
# then look just one at a time.

# production method = 1 (wild) 2 (farmed)

# check to see if converted right
shrimp.data %>% select(SPECIES, SP_GROUP, 
                       SIZE_GROUP2, SIZE_GROUP, SIZE_GROUP_NUM,
                       SHRIMP_PROCESSING, SHRIMP_PROCESSING_NUM,
                       ECOLABEL, ECOLABEL2) %>%
  #filter(SHRIMP_PROCESSING == "CKD TON") -> tmp
  filter(SIZE_GROUP == "Extra Large")->tmp
  #filter(is.na(SIZE_GROUP))-> tmp
```

We may include more variables in the next attempt but I thought this may be a good place to start.  Here I further change the variables into factor variables as the numbers don't mean much for these variables. I also added a variable of random numbers (RV) as a yardstick to which all variables are compared. If a variable is less useful than random numbers for predicing the price, they are not very useful. 

```{r}
shrimp.data %>% select(SP_GROUP, SP_GROUP_NUM,
                       SIZE_GROUP, SIZE_GROUP_NUM,
                       SHRIMP_PROCESSING, SHRIMP_PROCESSING_NUM,
                       YEAR, ZIP, MARKETTYPE, PRICE,
                       ECOLABEL2) %>% 
  mutate(ECOLABEL_f = as.factor(ECOLABEL2),
         SP_GROUP_f = as.factor(SP_GROUP_NUM),
         SIZE_GROUP_f = as.factor(SIZE_GROUP_NUM),
         MARKETTYPE_f = as.factor(MARKETTYPE),
         SHRIMP_PROCESSING_f = as.factor(SHRIMP_PROCESSING_NUM),
         ZIP_f = as.factor(ZIP),
         YEAR_f = as.factor(YEAR),
         RV = runif(nrow(shrimp.data), 
                           min = 0, 
                           max = 100)) %>%
  select(PRICE, ECOLABEL_f, SP_GROUP_f, SIZE_GROUP_f,
         MARKETTYPE_f, SHRIMP_PROCESSING_f,
         ZIP_f, YEAR_f, RV) %>%
  na.omit()-> shrimp.data.RF



M.1 <- as.formula("PRICE ~ SP_GROUP_f+
                       SIZE_GROUP_f +
                       SHRIMP_PROCESSING_f +
                       YEAR_f + ZIP_f + MARKETTYPE_f +
                       ECOLABEL_f + RV")

#p <- length(attr(terms(M.1), "term.labels"))
# floor(sqrt(p)) and try half and 2x that
#mtry <- floor(sqrt(p)/2)
#mtry <- floor(sqrt(p))
  

```


The variable importance metric is the mean difference in MSEs between out-of-bag (OOB) predictions and those from one variable permuted. The mean is computed from all trees and the mean divided by the standard deviation of the differences. 

```{r}
if (!file.exists("RData/RF_M_1_out.rds")){
  RF.M.1 <- randomForest(formula = M.1,
                         data = shrimp.data.RF,
                         ntree = ntree,
                         localImp = TRUE,
                         immportance = FALSE,
                         proximity = FALSE,
                         do.trace = 500)
  
  saveRDS(RF.M.1, file = "RData/RF_M_1_out.rds")
  
} else {
  RF.M.1 <- readRDS("RData/RF_M_1_out.rds")
}
RF.M.1
```
About 67% of variability was explained by the forest. 

Now I start looking at which variables are influential in predicting the price using randomForestExplainer package. 
```{r}
if (!file.exists("RData/RF_M_1_min_depth.rds")){
  min_depth_df <- min_depth_distribution(RF.M.1)
  
  saveRDS(min_depth_df, file = "RData/RF_M_1_min_depth.rds")
} else {
  min_depth_df <- readRDS(file = "RData/RF_M_1_min_depth.rds")
}

plot_min_depth_distribution(min_depth_df)

# if there were missing values, can use the option mean_sample = "relevant_trees" in the above call.
```

Zip code is an important variable! 

More importance measures:
```{r}
if (!file.exists("RData/RF_M_1_importance.rds")){
  importance_df <- measure_importance(RF.M.1)
  
  saveRDS(importance_df, file = "RData/RF_M_1_importance.rds")
} else {
  importance_df <- readRDS("RData/RF_M_1_importance.rds")
}

plot_multi_way_importance(importance_df, size_measure = "no_of_nodes")
```

```{r}
plot_multi_way_importance(importance_df, 
                          x_measure = "mse_increase", 
                          y_measure = "node_purity_increase", 
                          size_measure = "p_value", 
                          no_of_labels = 5)
```


```{r}
if (!file.exists("RData/RF_M_1_varImp.rds")){
  # type = 1 provides mean decrease in accuracy (MSE) 
  # type = 2 provides mean decrease in node impurity
  var.imp.RF <- sort(importance(RF.M.1, type = 1), 
                     decreasing = FALSE)
  saveRDS(var.imp.cRF, file = "RData/cRF_M_1_varImp.rds")
} else {
  var.imp.cRF <- readRDS("RData/cRF_M_1_varImp.rds")
}

if (!file.exists("RData/cRF_M_1_predict.rds")){
  pred.cRF.M.1 <- predict(cRF.M.1, newdata = NULL)
  saveRDS(pred.cRF.M.1, file = "RData/cRF_M_1_predict.rds")
} else {
  pred.cRF.M.1 <- readRDS("RData/cRF_M_1_predict.rds")
}

var.imp.RF.df <- data.frame(var.imp.cRF)
var.imp.cRF.df$Variable <- rownames(var.imp.cRF.df)

ggplot(data = var.imp.cRF.df) + 
  geom_point(aes(x = var.imp, 
                 y = reorder(Variable, var.imp)),
             size = 3) + 
  theme_bw() + 
  labs(x = "Variable importance") + 
  theme(axis.title.y = element_blank(),
        axis.title.x = element_text(size =12))

```


Let's use another method to see how that comes out.
```{r}

if (!file.exists("RData/RFpermute_M_1.rds")){
  var.imp.rfPermute <- rfPermute(formula = M.1,
                                 data = shrimp.data.RF,
                                 ntree = ntree)
  #,num.cores = 1
  saveRDS(var.imp.rfPermute, file = "RData/RFpermute_M_1.rds")
} else {
  var.imp.rfPermute <- readRDS(file = "RData/RFpermute_M_1.rds")
  
}

p1 <- plot(rp.importance(var.imp.rfPermute, scale = F))
# The scale option doesn't seem to do anything... 
```

The first one (SIZE_GROUP) is the same as the other method (cforest) but the second one (MARKETTYPE) was not the same. But the top three are still the same: SIZE_GROUP, MARKETTYPE, and SHRIMP_PROCESSING. Interestingly, Ecolabel is not very important. 

